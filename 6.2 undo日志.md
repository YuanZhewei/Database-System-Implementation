### 日志记录

各种日志记录公有的记录形式有以下几种形式：

1. $<START \ T>$：表示事务$T$已开始
2. $<COMMIT \ T>$：事务$T$已成功完成并对数据库元素不会再有修改。$T$对数据库所做的任何更新都反映到磁盘上。然而由于缓冲区管理器决定何时将块从主存写入磁盘是不确定的，当看到$<COMMIT\ T>$日志记录时，并不能确认更新已经在磁盘上。如果我们坚持更新已经在磁盘上，那么这一要求必须由日志管理器来体现。
3. $<ABORT\ T>$：事务$T$不能成功完成。如果事务$T$中止，它所做的更新都不能拷贝到磁盘上，并且事务管理器有责任保证这样的更新绝不出现在磁盘上，或者如果已经出现就要消除对磁盘的影响。

对undo日志而言，唯一需要的其他日志记录类型是**更新日志**，更新日志是一个三元组$<T, X, v>$。这一记录的含义是：事务$T$改变了数据库元素$X$，而$X$原来的值是$v$。更新记录所反映的改变通常发生在主存上而不是磁盘上；即日志记录是对写入内存的$WRITE$动作做出的反应，而不是对写入磁盘$OUTPUT$动作做出的反应。

### undo日志规则

只要事务和缓冲区管理器遵从以下两条规则，undo日志就能保证从系统故障中恢复。

$U_1$：如果事务$T$改变了数据库元素$X$，那么形如$<T, X, v>$的日志记录必须在$X$的新值写到磁盘之前写到磁盘中。

$U_2$：如果事务提交，则其$COMMIT$日志记录必须在事务改变的所有数据库元素先写到磁盘后写到磁盘中，但应尽快。

简要概括规则$U_1$和$U_2$，与一个事务相关的内容必须按如下顺序写到磁盘：

1. 指明所改变数据库元素的日志记录
2. 改变数据库元素自身
3. COMMIT的日志记录

1和2的顺序是对各个数据库元素单独适用，而不是对事务的更新记录集合整个适用。

为了强制将日志记录写到磁盘上，日志记录需要一条**刷新日志**命令来告诉缓冲区管理器将以前没有刷新到磁盘的日志记录从上一次刷新以来发生修改的日志记录刷新到磁盘。在动作的序列中，我们将显式地给出$FLUSH\ LOG$。事务管理器还需要以某种方式告诉缓冲区管理器在某个数据库元素上执行$OUTPUT$动作。

例：数据库中包含两个元素$A$和$B$，这两个元素要满足的约束是在任何一致的状态中它们的值相等。

事务$T$逻辑上由下述两步构成
$$
A := A * 2; \\
B := B * 2;
$$

| 步骤 |     动作      | $t$  | $M-A$ | $M-B$ | $D-A$ | $D-B$ |     日志      |
| :--: | :-----------: | :--: | :---: | :---: | :---: | :---: | :-----------: |
| $1$  |               |      |       |       |       |       | $<START\ T>$  |
| $2$  | $READ(A, t)$  | $8$  |  $8$  |       |  $8$  |  $8$  |               |
| $3$  | $t := t * 2$  | $16$ |  $8$  |       |  $8$  |  $8$  |               |
| $4$  | $WHERE(A, t)$ | $16$ | $16$  |       |  $8$  |  $8$  |  $<T, A, 8>$  |
| $5$  | $READ(B, t)$  | $8$  | $16$  |  $8$  |  $8$  |  $8$  |               |
| $6$  | $t := t * 2$  | $16$ | $16$  |  $8$  |  $8$  |  $8$  |               |
| $7$  | $WHERE(B, t)$ | $16$ | $16$  | $16$  |  $8$  |  $8$  |  $<T, B, 8>$  |
| $8$  | $FLUSH\ LOG$  |      |       |       |       |       |               |
| $9$  |  $OUTPUT(A)$  | $16$ | $16$  | $16$  | $16$  |  $8$  |               |
| $10$ |  $OUTPUT(B)$  | $16$ | $16$  | $16$  | $16$  | $16$  |               |
| $11$ |               |      |       |       |       |       | $<COMMIT\ T>$ |
| $12$ | $FLUSH\ LOG$  |      |       |       |       |       |               |

### 使用undo日志的恢复



### 检查点



###非静止检查点