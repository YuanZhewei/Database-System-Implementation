##长事务

### 长事务的问题

可能出现长事务的3大类应用为：

1. **传统的DBMS应用**。
2. **设计系统**。
3. **工作流系统**。

### saga(系列记载)

saga是构成长“事务”的一系列动作，包括：

1. 一些列动作。
2. 一个图，其结点是动作结点或终止结点：Abort及Complete结点。不存在从终止结点发出的弧。
3. 关于动作从哪个结点开始的指示，这一结点被称作开始结点。

图中从开始结点到终止结点之间的路径表示可能的动作序列。通向Abort结点的路径表示导致整个事务回滚的动作序列，这些动作序列不应该改变数据库。通向Complete节点的路径表示成功的动作序列，这些动作对数据库所做的改变都将保留在数据库中。

saga的并发控制通过两方面的能力来管理：

1. 可以认为每个动作自身是一个短事务，在执行时使用传统的并发控制机制，如封锁。
2. 整个事务即任何通向终止结点的路径通过补偿事务机制来管理，补偿事务是saga在各个结点上的事务的逆。

### 补偿事务

在sage中，每个动作$A$都有一个补偿事务$A^{-1}$。直观的说，如果我们执行$A$，后来有执行$A^{-1}$，那么所产生的数据库状态同$A$和$A^{-1}$都未执行前一样。

* 如果$D$是任一数据库状态，$B_1B_2\ldots B_n$是动作和补偿事务的任一序列(不管来自所讨论的saga还是来自数据库上合法执行的任何其他的saga事务)，那么数据库状态$D$上开始运行序列$B_1B_2\ldots B_n$和$AB_1B_2\ldots B_nA^{-1}$所产生的数据库状态一样。

如果saga的执行通向Abort结点，那么我们通过为每个已执行的动作执行补偿事务来回滚saga，补偿事务执行的顺序与对应动作执行的顺序相反。

### 补偿事务发挥作用的原因

归纳法，略。