## 分布式提交

### 两阶段提交

* 两阶段提交中，假设每个节点记录该节点上动作的日志，但没有全局的日志。
* 假设一个称作**协调器**的节点在决定分布式事务是否提交中扮演特殊的角色。例如，协调器可能是发起事务的节点。
* 两阶段提交协议涉及协调器和其他节点之间的消息发送。在发送每条消息时，发送节点都要把该消息记录到日志中，以便在需要恢复时提供帮助。

#### 阶段I

1. 协调器在所在节点的日志中放入$<Prepare\ T>$日志记录。
2. 协调器向各个节点(原则上包括自己)发送消息$prepare\ T$。
3. 每个接收到消息$prepare\ T$的节点决定该节点上$T$是提交还是中止。如果事务尚未完成其行动，节点可以推迟发送响应的消息，但终究是要发送的。
4. 如果节点希望提交其事务，就必须进入一个称为**预提交**的状态。一旦进入预提交状态，节点就不能中止$T$，除非协调器指示中止事务。进入预提交状态必须执行如下步骤：
a. 执行$T$的局部成分
b. 在局部日志中放入记录$<Ready\ T>$并将日志刷新到磁盘。
c. 向协调器发送$ready T$消息。
5. 如果节点希望中止其$T$成分，那么它记录日志$<Don't\ commit\ T>$并向协调器发送消息$don't\ commit\ T$。这时中止事务成分是安全的。
#### 阶段II

1. 如果协调器从$T$的所有参与者收到的都是$ready\ T$，那么它就决定提交$T$。协调器在其节点中记载$<Commit\ T>$日志记录，并且向参与$T$的所有节点发送$commit\ T$消息。
2. 只要协调器收到一个$don't\ commit\ T$消息，那么它在节点上记录$<Abort\ T>$日志记录，并且向 参与$T$的所有节点发送$abort\ T$消息。
3. 如果节点收到$commit\ T$消息，该节点将提交其上$T$成分，并在此过程中记录日志$<Commit\ T>$。
4. 如果节点收到$abort\ T$消息，该节点将中止$T$并记录$Abort\ T$。

###分布式事务的恢复
1. 如果最后一个日志记录是$<Commit\ T>$，$<Abort\ T>$，$<Don't\ commit\ T>$，分别重做或撤销事务即可。
2. 如果最后一个日志记录是$<Ready T>$。则现在全局状态未知，该节点需要和其他至少一个节点交流。如果协调器在工作，询问协调器，否则询问其他节点。最还情况下，该事务保持活跃。
3. 局部日志中可能没有$T$在两阶段提交协议中的动作的记录，如果这样，那么恢复节点可以单方面决定中止其$T$成分。

如果协调器重新选举：
1. 如果某个节点的日志有$<Commit\ T>$或$<Abort\ T>$记录，那么原协调器已经做出决定，发送$commit\ T$和$abort\ T$消息即可。
2. 如果没有$<Commit\ T>$或$<Abort\ T>$记录，但至少有一个节点的日志中没有$<Ready\ T>$，则中止事务是安全的。
3. 否则必须等原协调器恢复。