## 分布式封锁

### 集中封锁系统

最简单的方法是指定一个**封锁节点**来维护一张逻辑元素的锁表。

每个锁的开销为三次消息传递(请求、授予、释放)。

### 分布式封锁算法的代价

封锁任何其他节点上的元素$X$需要以下三条消息：

1. 发向$X$所在节点以请求封锁的消息。
2. 授予锁的回答消息。
3. 发向$X$所在节点以释放锁的消息。

### 封锁多副本的元素

* 一个逻辑元素$X$可以有一个排他锁而没有共享锁，也可以有任意个共享锁而没有排他锁。

### 主副本封锁

每个逻辑元素的封锁只由一个节点负责，这样的分布封锁称为**主副本方式**。

### 局部锁构成的全局锁

假设数据库元素$A$有$n$个元素：

1. $s$是事务获得$A$上的全局共享锁时必须以共享方式封锁的$A$的副本数。
2. $x$是事务获得$A$上的排他锁时必须以排他方式封锁的$A$的副本数。

只要$2x > n$且$s + x > n$，就能获得所需的性质：$A$上只能有一个排他锁，$A$上不能既有一个排他锁又有一个共享锁。

由于$2x > n$，如果两个事务都有$X$上的全局排他锁，那么至少有一个副本为这两个事务授予了局部排他锁。但是如果这样的话，局部封锁方式就是错误的。如果$s+x > n$，必然有某个副本同时授予了局部共享锁和排他锁。

* $s = 1$，$x = n$，当大多数是只读事务，但读文档$X$的事务在不同节点上发起时，这一方法比较优越。
* $s = x = \lceil (n + 1) / 2\rceil$